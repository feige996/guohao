<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问诊记录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入共享问诊工具函数库 -->
    <script src="consultation-utils.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        /* Toast 样式 */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 280px;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* 标签页激活状态 */
        .tab-active {
            color: #8E4337;
            background: #F5EBE9;
            font-weight: 600;
        }

        /* 滚动容器 */
        .tabs-container {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        /* 卡片动效 */
        .record-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .record-card:active {
            transform: scale(0.98);
        }

        /* 时间轴装饰 */
        .timeline-dot {
            position: relative;
        }
        
        .timeline-dot::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .timeline-dot::after {
            content: '';
            position: absolute;
            left: -25px;
            top: 50%;
            width: 2px;
            height: 100%;
            background: #E5E7EB;
        }

        /* 状态标签脉动效果 */
        @keyframes pulse-ongoing {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.4);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(234, 88, 12, 0);
            }
        }
        
        .status-ongoing {
            animation: pulse-ongoing 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 开方按钮动效 */
        .prescription-btn {
            position: relative;
            overflow: hidden;
        }
        
        .prescription-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .prescription-btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* 模态弹窗 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: calc(100% - 48px);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .modal-overlay.show .modal-content {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    </style>
</head>
<body class="bg-[#F9FAFB]">
    <div class="w-full  mx-auto min-h-screen relative pb-5">
        <!-- Toast 通知 -->
        <div id="toast" class="toast"></div>

        <!-- 确认弹窗 -->
        <div id="confirmModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-content">
                <div id="modalContent" class="mb-6">
                    <div id="modalIcon" class="w-12 h-12 rounded-full bg-[#F5EBE9] flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#8E4337" class="w-6 h-6">
                            <path d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a1.875 1.875 0 01-1.875-1.875V5.25A3.75 3.75 0 009 1.5H5.625z" />
                            <path d="M12.971 1.816A5.23 5.23 0 0114.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 013.434 1.279 9.768 9.768 0 00-6.963-6.963z" />
                        </svg>
                    </div>
                    <h3 id="modalTitle" class="text-lg font-bold text-[#1F2937] text-center mb-2">结束问诊</h3>
                    <p id="modalMessage" class="text-sm text-[#6B7280] text-center leading-relaxed"></p>
                </div>
                <div id="modalButtons" class="grid grid-cols-2 gap-3">
                    <button 
                        id="modalCancelBtn"
                        class="py-3 border-2 border-[#E5E7EB] rounded-lg text-[#6B7280] text-sm font-medium cursor-pointer hover:bg-[#F9FAFB] transition-colors active:scale-98"
                        onclick="closeModal()"
                        aria-label="取消">
                        取消
                    </button>
                    <button 
                        id="modalConfirmBtn"
                        class="py-3 bg-[#8E4337] rounded-lg text-white text-sm font-medium cursor-pointer hover:bg-[#6E2F25] transition-colors active:scale-98"
                        aria-label="确认">
                        确认结束
                    </button>
                </div>
            </div>
        </div>

        <!-- 顶部导航 -->
        <header class="w-full h-[56px] flex justify-between items-center px-4 bg-white fixed top-0 left-0 right-0  mx-auto z-50 shadow-sm">
            <button id="backBtn" class="text-[#333333] hover:text-[#6B7280] transition-colors" onclick="goBack()" aria-label="返回上一页">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M7.28 7.72a.75.75 0 010 1.06l-2.47 2.47H21a.75.75 0 010 1.5H4.81l2.47 2.47a.75.75 0 11-1.06 1.06l-3.75-3.75a.75.75 0 010-1.06l3.75-3.75a.75.75 0 011.06 0z" clip-rule="evenodd" />
                </svg>
            </button>
            <h1 id="pageTitle" class="text-[#333333] text-lg font-bold leading-7">问诊记录</h1>
            <button id="searchBtn" class="text-[#8E4337] hover:text-[#6E2F25] transition-colors" onclick="toggleSearchBar()" aria-label="搜索问诊记录">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" />
                </svg>
            </button>
            
            <!-- 搜索栏 -->
            <div id="searchBar" class="absolute inset-0 bg-white px-4 flex items-center gap-3 opacity-0 pointer-events-none transition-opacity duration-300">
                <button onclick="hideSearchBar()" class="text-[#6B7280] hover:text-[#333333] transition-colors" aria-label="取消搜索">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.28 7.72a.75.75 0 010 1.06l-2.47 2.47H21a.75.75 0 010 1.5H4.81l2.47 2.47a.75.75 0 11-1.06 1.06l-3.75-3.75a.75.75 0 010-1.06l3.75-3.75a.75.75 0 011.06 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="搜索患者姓名..."
                        oninput="handleSearch()"
                        class="w-full pl-10 pr-10 py-2 bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg text-sm text-[#1F2937] placeholder-[#9CA3AF] focus:outline-none focus:ring-2 focus:ring-[#8E4337] focus:border-transparent"
                    />
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#9CA3AF" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                    <button 
                        id="clearSearchBtn"
                        onclick="clearSearch()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-[#9CA3AF] hover:text-[#6B7280] transition-colors hidden"
                        aria-label="清除搜索">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- 标签页导航 -->
        <div class="mt-[56px] bg-white px-4 py-3 sticky top-[56px] z-40 shadow-sm">
            <div class="tabs-container flex gap-2">
                <button 
                    id="tab-all"
                    onclick="switchTab('all')" 
                    class="tab-active px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors"
                    aria-label="全部">
                    全部
                </button>
                <button 
                    id="tab-ongoing"
                    onclick="switchTab('ongoing')" 
                    class="px-4 py-2 rounded-full text-sm font-medium text-[#6B7280] hover:bg-[#F9FAFB] whitespace-nowrap transition-colors"
                    aria-label="进行中">
                    进行中
                </button>
                <button 
                    id="tab-completed"
                    onclick="switchTab('completed')" 
                    class="px-4 py-2 rounded-full text-sm font-medium text-[#6B7280] hover:bg-[#F9FAFB] whitespace-nowrap transition-colors"
                    aria-label="已完成">
                    已完成
                </button>
                <button 
                    id="tab-unprescribed"
                    onclick="switchTab('unprescribed')" 
                    class="px-4 py-2 rounded-full text-sm font-medium text-[#6B7280] hover:bg-[#F9FAFB] whitespace-nowrap transition-colors"
                    aria-label="未开方">
                    未开方
                </button>
            </div>
        </div>

        <!-- 问诊记录列表 -->
        <main id="recordsList" class="px-4 pt-4 space-y-4">
            <!-- 已完成记录 -->
            <article class="record-card w-full p-5 rounded-[20px] shadow-[0px_4px_12px_0px_rgba(0,0,0,0.05)] bg-white border border-[#F3F4F6] hover:shadow-[0px_8px_24px_0px_rgba(0,0,0,0.08)] hover:border-[#8E4337]/20 transition-all" data-patient-name="王女士" data-status="completed" data-prescribed="true">
                <!-- 患者信息 -->
                <div class="flex items-center gap-3 mb-4">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-[#F5EBE9]">
                            <img src="https://cdn.pixabay.com/photo/2017/03/14/03/20/woman-2141808_640.jpg" alt="王女士" class="w-full h-full object-cover">
                        </div>
                        <!-- 问诊类型图标 -->
                        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-gradient-to-br from-[#8E4337] to-[#6E2F25] rounded-full flex items-center justify-center border-2 border-white shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white" class="w-3 h-3">
                                <path d="M2.87 2.298a.75.75 0 0 0-.812 1.021L3.39 6.624a1 1 0 0 0 .928.626H8.25a.75.75 0 0 1 0 1.5H4.318a1 1 0 0 0-.927.626l-1.333 3.305a.75.75 0 0 0 .811 1.022 24.89 24.89 0 0 0 11.668-5.115.75.75 0 0 0 0-1.175A24.89 24.89 0 0 0 2.869 2.298Z" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <h3 class="text-[#1F2937] text-base font-bold mb-1">王女士 · 28岁</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-[#6B7280] text-xs">图文问诊</span>
                                    <span class="w-1 h-1 bg-[#D1D5DB] rounded-full"></span>
                                    <span class="text-[#9CA3AF] text-xs">10-26 14:30</span>
                                </div>
                            </div>
                            <span class="px-2.5 py-1 bg-[#D1FAE5] rounded-full text-[#10B981] text-xs font-bold whitespace-nowrap">
                                已完成
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 开方状态卡片 -->
                <div class="mb-4 p-3 bg-[#F9FAFB] rounded-xl border border-[#F3F4F6]">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-[#10B981] rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white" class="w-4 h-4">
                                    <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div>
                                <div class="text-[#6B7280] text-xs font-medium">开方状态</div>
                                <div class="text-[#10B981] text-sm font-bold">已开方</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="grid grid-cols-2 gap-3">
                    <button 
                        onclick="viewConsultationDetail('1')"
                        class="py-3 border-2 border-[#8E4337] rounded-xl text-[#8E4337] text-sm font-semibold hover:bg-[#F5EBE9] transition-all active:scale-95 flex items-center justify-center gap-2"
                        aria-label="查看详情">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                            <path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                            <path fill-rule="evenodd" d="M1.38 8.28a.87.87 0 0 1 0-.566 7.003 7.003 0 0 1 13.238.006.87.87 0 0 1 0 .566A7.003 7.003 0 0 1 1.379 8.28ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" clip-rule="evenodd" />
                        </svg>
                        查看详情
                    </button>
                    <button 
                        onclick="openIMChat('王女士', '28岁', '女', 'https://cdn.pixabay.com/photo/2017/03/14/03/20/woman-2141808_640.jpg', '头痛、失眠、疲劳')"
                        class="py-3 bg-gradient-to-r from-[#8E4337] to-[#6E2F25] rounded-xl text-white text-sm font-semibold hover:from-[#6E2F25] hover:to-[#5A2520] transition-all active:scale-95 shadow-lg shadow-[#8E4337]/30 flex items-center justify-center gap-2"
                        aria-label="查看图文问诊记录">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                            <path d="M2.87 2.298a.75.75 0 0 0-.812 1.021L3.39 6.624a1 1 0 0 0 .928.626H8.25a.75.75 0 0 1 0 1.5H4.318a1 1 0 0 0-.927.626l-1.333 3.305a.75.75 0 0 0 .811 1.022 24.89 24.89 0 0 0 11.668-5.115.75.75 0 0 0 0-1.175A24.89 24.89 0 0 0 2.869 2.298Z" />
                        </svg>
                        问诊记录
                    </button>
                </div>
            </article>

            <!-- 进行中记录 - 突出显示 -->
            <article class="record-card w-full p-5 rounded-[20px] shadow-[0px_4px_12px_0px_rgba(0,0,0,0.05)] bg-white border-2 border-[#FEE2E2] hover:shadow-[0px_8px_24px_0px_rgba(0,0,0,0.08)] hover:border-[#8E4337]/30 transition-all relative overflow-hidden" data-patient-name="李先生" data-status="ongoing" data-prescribed="false">
                <!-- 装饰元素 -->
                <div class="absolute top-0 right-0 w-32 h-32 -mr-16 -mt-16 bg-[#EF4444] opacity-10 rounded-full"></div>
                
                <!-- 患者信息 -->
                <div class="flex items-center gap-3 mb-4 relative z-10">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-[#F5EBE9]">
                            <img src="https://cdn.pixabay.com/photo/2018/01/04/21/15/young-3061652_640.jpg" alt="李先生" class="w-full h-full object-cover">
                        </div>
                        <!-- 视频问诊图标 -->
                        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-gradient-to-br from-[#8E4337] to-[#6E2F25] rounded-full flex items-center justify-center border-2 border-white shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white" class="w-3 h-3">
                                <path d="M5 4.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-5a.5.5 0 0 1-.5-.5v-7Z" />
                                <path d="M11.5 6.823v2.354c.274-.176.5-.46.5-.823v-.708a1 1 0 0 0-.5-.823Z" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <h3 class="text-[#1F2937] text-base font-bold mb-1">李先生 · 35岁</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-[#6B7280] text-xs">视频问诊</span>
                                    <span class="w-1 h-1 bg-[#D1D5DB] rounded-full"></span>
                                    <span class="text-[#9CA3AF] text-xs">10-24 09:00</span>
                                </div>
                            </div>
                            <span class="status-ongoing px-2.5 py-1 bg-[#FFF7ED] rounded-full text-[#EA580C] text-xs font-bold whitespace-nowrap flex items-center gap-1">
                                <span class="w-1.5 h-1.5 bg-[#EA580C] rounded-full animate-pulse"></span>
                                进行中
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 开方状态 - 未开方提示 -->
                <div class="mb-4 p-3 bg-[#F9FAFB] rounded-xl border border-[#F3F4F6] relative z-10">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-[#EF4444] rounded-lg flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white" class="w-4 h-4">
                                    <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14ZM8 4a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div>
                                <div class="text-[#6B7280] text-xs font-medium">开方状态</div>
                                <div class="text-[#EF4444] text-sm font-bold">未开方</div>
                            </div>
                        </div>
                        <button 
                            onclick="goToPrescription('2')"
                            class="prescription-btn px-3 py-1.5 bg-gradient-to-r from-[#8E4337] to-[#6E2F25] rounded-lg text-white text-xs font-semibold hover:from-[#6E2F25] hover:to-[#5A2520] transition-all active:scale-95 shadow-md flex items-center gap-1"
                            aria-label="去开方">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5">
                                <path fill-rule="evenodd" d="M4.5 2A1.5 1.5 0 0 0 3 3.5v9A1.5 1.5 0 0 0 4.5 14h7a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 11.5 2h-7Zm2.354 5.854a.5.5 0 1 1-.708-.708L7.793 5.5 6.146 3.854a.5.5 0 1 1 .708-.708l2 2a.5.5 0 0 1 0 .708l-2 2ZM9.5 9a.5.5 0 0 0 0 1h-3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1Z" clip-rule="evenodd" />
                            </svg>
                            去开方
                        </button>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="grid grid-cols-2 gap-3 relative z-10">
                    <button 
                        onclick="openIMChat('李先生', '35岁', '男', 'https://cdn.pixabay.com/photo/2018/01/04/21/15/young-3061652_640.jpg', '头痛、咳嗽、咽痛')"
                        class="py-3 bg-gradient-to-r from-[#8E4337] to-[#6E2F25] rounded-xl text-white text-sm font-semibold hover:from-[#6E2F25] hover:to-[#5A2520] transition-all active:scale-95 shadow-lg shadow-[#8E4337]/30 flex items-center justify-center gap-2"
                        aria-label="进入问诊">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M2 4.75A2.75 2.75 0 0 1 4.75 2h3a2.75 2.75 0 0 1 2.45 4H11a2.5 2.5 0 0 1 2.45 3h.05A2.5 2.5 0 0 1 11 13.5H4.75A2.75 2.75 0 0 1 2 10.75v-6Zm2.75-1.25a1.25 1.25 0 1 0 0 2.5h3a1.25 1.25 0 1 0 0-2.5h-3ZM3.5 7.5A1.25 1.25 0 0 1 4.75 6.25H11A1 1 0 0 1 12 7.25v.05a1 1 0 0 1-.25.68 1 1 0 0 1-.75.32H4.75A1.25 1.25 0 0 1 3.5 7.5Zm.25 2.25a1.25 1.25 0 1 0 0 2.5H11a1 1 0 1 0 0-2H4.75a1.25 1.25 0 0 0-1 .5Z" clip-rule="evenodd" />
                        </svg>
                        进入问诊
                    </button>
                    <button 
                        onclick="endConsultation('2')"
                        class="py-3 bg-[#B45309] rounded-xl text-white text-sm font-semibold hover:bg-[#92400E] transition-all active:scale-95 shadow-lg shadow-[#B45309]/30 flex items-center justify-center gap-2"
                        aria-label="结束问诊">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
                        </svg>
                        结束问诊
                    </button>
                </div>
            </article>

            <!-- 底部提示 -->
            <div class="text-center py-4">
                <span class="text-[#9CA3AF] text-sm">没有更多了</span>
            </div>
        </main>

        <!-- IM 聊天弹窗 -->
        <div id="imChatModal" class="fixed inset-0 bg-white z-[100] transform translate-y-full transition-transform duration-300">
            <!-- 顶部导航栏 -->
            <div class="w-full h-[56px] flex justify-between items-center px-4 bg-white border-b border-[#E5E7EB]">
                <button onclick="closeIMChat()" class="text-[#333333] hover:text-[#8E4337] transition-colors" aria-label="返回">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M7.28 7.72a.75.75 0 010 1.06l-2.47 2.47H21a.75.75 0 010 1.5H4.81l2.47 2.47a.75.75 0 11-1.06 1.06l-3.75-3.75a.75.75 0 010-1.06l3.75-3.75a.75.75 0 011.06 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full overflow-hidden" id="imPatientAvatar">
                        <img src="" alt="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h3 id="imPatientName" class="text-[#333333] text-base font-bold"></h3>
                        <p id="imPatientInfo" class="text-[#9CA3AF] text-xs"></p>
                    </div>
                </div>
                <button class="text-[#8E4337] hover:text-[#6E2F25] transition-colors" aria-label="更多选项">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M10.5 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm0 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm0 6a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- 主诉信息卡片 -->
            <div class="px-4 py-3 bg-[#FFF7ED] border-b border-[#FEE2E2]">
                <div class="flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#EA580C" class="w-4 h-4 mt-0.5 flex-shrink-0">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="flex-1">
                        <p class="text-[#EA580C] text-xs font-medium mb-0.5">患者主诉</p>
                        <p id="imChiefComplaint" class="text-[#6B7280] text-sm"></p>
                    </div>
                </div>
            </div>

            <!-- 消息列表区域 -->
            <div id="imMessageList" class="flex-1 overflow-y-auto px-4 py-4 bg-[#F9FAFB]" style="height: calc(100vh - 56px - 60px - 72px);">
                <!-- 时间分隔 -->
                <div class="flex justify-center mb-4">
                    <span class="px-3 py-1 bg-white rounded-full text-[#9CA3AF] text-xs">今天 10:30</span>
                </div>

                <!-- 患者消息 -->
                <div class="flex gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="https://cdn.pixabay.com/photo/2018/01/04/21/15/young-3061652_640.jpg" alt="患者" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 max-w-[70%]">
                        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
                            <p class="text-[#333333] text-sm leading-relaxed">医生您好，我这几天一直头痛，咳嗽，喉咙也很痛。</p>
                        </div>
                        <span class="text-[#9CA3AF] text-xs ml-2 mt-1 inline-block">10:30</span>
                    </div>
                </div>

                <!-- 医生消息 -->
                <div class="flex gap-2 mb-4 justify-end">
                    <div class="flex-1 max-w-[70%] flex flex-col items-end">
                        <div class="bg-gradient-to-br from-[#8E4337] to-[#6E2F25] rounded-2xl rounded-tr-sm px-4 py-3 shadow-sm">
                            <p class="text-white text-sm leading-relaxed">您好，请问这种情况持续多久了？有发烧吗？</p>
                        </div>
                        <span class="text-[#9CA3AF] text-xs mr-2 mt-1">10:31</span>
                    </div>
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-gradient-to-br from-[#8E4337] to-[#6E2F25] flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-5 h-5">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                </div>

                <!-- 患者消息 -->
                <div class="flex gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="https://cdn.pixabay.com/photo/2018/01/04/21/15/young-3061652_640.jpg" alt="患者" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 max-w-[70%]">
                        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
                            <p class="text-[#333333] text-sm leading-relaxed">已经3天了，没有发烧，就是头痛咳嗽比较严重。</p>
                        </div>
                        <span class="text-[#9CA3AF] text-xs ml-2 mt-1 inline-block">10:32</span>
                    </div>
                </div>
            </div>

            <!-- 底部输入区域 -->
            <div class="w-full bg-white border-t border-[#E5E7EB] p-3">
                <div class="flex items-end gap-2">
                    <button class="w-9 h-9 flex items-center justify-center text-[#6B7280] hover:text-[#8E4337] transition-colors" aria-label="表情">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-2.625 6c-.54 0-.828.419-.936.634a1.96 1.96 0 00-.189.866c0 .298.059.605.189.866.108.215.395.634.936.634.54 0 .828-.419.936-.634.13-.26.189-.568.189-.866 0-.298-.059-.605-.189-.866-.108-.215-.395-.634-.936-.634zm4.314.634c.108-.215.395-.634.936-.634.54 0 .828.419.936.634.13.26.189.568.189.866 0 .298-.059.605-.189.866-.108.215-.395.634-.936.634-.54 0-.828-.419-.936-.634a1.96 1.96 0 01-.189-.866c0-.298.059-.605.189-.866zm2.023 6.828a.75.75 0 10-1.06-1.06 3.75 3.75 0 01-5.304 0 .75.75 0 00-1.06 1.06 5.25 5.25 0 007.424 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button class="w-9 h-9 flex items-center justify-center text-[#6B7280] hover:text-[#8E4337] transition-colors" aria-label="图片">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="flex-1 bg-[#F9FAFB] rounded-lg border border-[#E5E7EB] focus-within:border-[#8E4337] transition-colors">
                        <textarea 
                            id="imMessageInput"
                            rows="1"
                            placeholder="输入消息..."
                            class="w-full px-3 py-2 bg-transparent resize-none focus:outline-none text-sm text-[#333333] placeholder-[#9CA3AF]"
                            style="max-height: 80px;"
                        ></textarea>
                    </div>
                    <button onclick="sendIMMessage()" class="w-9 h-9 flex items-center justify-center bg-[#8E4337] hover:bg-[#6E2F25] rounded-lg transition-colors" aria-label="发送">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-5 h-5">
                            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toast 提示
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 切换搜索栏显示/隐藏
        function toggleSearchBar() {
            const searchBar = document.getElementById('searchBar');
            const backBtn = document.getElementById('backBtn');
            const pageTitle = document.getElementById('pageTitle');
            const searchBtn = document.getElementById('searchBtn');
            
            if (searchBar.classList.contains('opacity-0')) {
                // 显示搜索栏
                searchBar.classList.remove('opacity-0', 'pointer-events-none');
                searchBar.classList.add('opacity-100', 'pointer-events-auto');
                backBtn.classList.add('opacity-0', 'pointer-events-none');
                pageTitle.classList.add('opacity-0', 'pointer-events-none');
                searchBtn.classList.add('opacity-0', 'pointer-events-none');
                
                // 自动聚焦到搜索框
                setTimeout(() => {
                    document.getElementById('searchInput').focus();
                }, 300);
            } else {
                // 隐藏搜索栏
                hideSearchBar();
            }
        }

        // 隐藏搜索栏
        function hideSearchBar() {
            const searchBar = document.getElementById('searchBar');
            const backBtn = document.getElementById('backBtn');
            const pageTitle = document.getElementById('pageTitle');
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            
            searchBar.classList.add('opacity-0', 'pointer-events-none');
            searchBar.classList.remove('opacity-100', 'pointer-events-auto');
            backBtn.classList.remove('opacity-0', 'pointer-events-none');
            pageTitle.classList.remove('opacity-0', 'pointer-events-none');
            searchBtn.classList.remove('opacity-0', 'pointer-events-none');
            
            // 清空搜索框
            searchInput.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            
            // 恢复显示所有记录
            filterRecords('');
        }

        // 清除搜索
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchInput.focus();
            document.getElementById('clearSearchBtn').classList.add('hidden');
            filterRecords('');
        }

        // 处理搜索
        function handleSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim();
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // 显示/隐藏清除按钮
            if (searchTerm) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            
            // 执行搜索过滤
            filterRecords(searchTerm);
        }

        // 过滤记录
        function filterRecords(searchTerm) {
            const records = document.querySelectorAll('.record-card');
            let visibleCount = 0;
            
            records.forEach(record => {
                const patientName = record.getAttribute('data-patient-name') || '';
                
                if (!searchTerm || patientName.toLowerCase().includes(searchTerm.toLowerCase())) {
                    record.style.display = '';
                    visibleCount++;
                } else {
                    record.style.display = 'none';
                }
            });
            
            // 更新底部提示
            const bottomHint = document.querySelector('main > div:last-child');
            if (bottomHint) {
                if (visibleCount === 0 && searchTerm) {
                    bottomHint.innerHTML = '<span class="text-[#9CA3AF] text-sm">未找到匹配的患者</span>';
                } else if (visibleCount === 0) {
                    bottomHint.innerHTML = '<span class="text-[#9CA3AF] text-sm">暂无问诊记录</span>';
                } else {
                    bottomHint.innerHTML = '<span class="text-[#9CA3AF] text-sm">没有更多了</span>';
                }
            }
        }

        // 切换标签页
        function switchTab(tab) {
            // 移除所有标签的激活状态
            ['all', 'ongoing', 'completed', 'unprescribed'].forEach(t => {
                const tabElement = document.getElementById(`tab-${t}`);
                tabElement.classList.remove('tab-active', 'text-[#8E4337]', 'bg-[#F5EBE9]');
                tabElement.classList.add('text-[#6B7280]', 'hover:bg-[#F9FAFB]');
            });

            // 激活当前标签
            const currentTab = document.getElementById(`tab-${tab}`);
            currentTab.classList.add('tab-active', 'text-[#8E4337]', 'bg-[#F5EBE9]');
            currentTab.classList.remove('text-[#6B7280]', 'hover:bg-[#F9FAFB]');

            // 根据标签筛选内容
            const tabNames = {
                'all': '全部',
                'ongoing': '进行中',
                'completed': '已完成',
                'unprescribed': '未开方'
            };
            showToast(`切换到${tabNames[tab]}`);
        }

        // 查看问诊详情
        function viewConsultationDetail(consultationId) {
            showToast('正在加载详情...');
            setTimeout(() => {
                window.location.href = 'consultation-detail.html?id=' + consultationId;
            }, 500);
        }

        // 打开IM聊天窗口
        function openIMChat(patientName, age, gender, avatar, chiefComplaint) {
            const modal = document.getElementById('imChatModal');
            const avatarImg = document.getElementById('imPatientAvatar').querySelector('img');
            const nameEl = document.getElementById('imPatientName');
            const infoEl = document.getElementById('imPatientInfo');
            const complaintEl = document.getElementById('imChiefComplaint');
            
            // 设置患者信息
            avatarImg.src = avatar;
            avatarImg.alt = patientName;
            nameEl.textContent = patientName;
            infoEl.textContent = `${age} · ${gender}`;
            complaintEl.textContent = chiefComplaint;
            
            // 显示弹窗（向上滑入）
            modal.classList.remove('translate-y-full');
            modal.classList.add('translate-y-0');
            
            // 禁止底层页面滚动
            document.body.style.overflow = 'hidden';
            
            // 滚动到消息列表底部
            setTimeout(() => {
                const messageList = document.getElementById('imMessageList');
                messageList.scrollTop = messageList.scrollHeight;
            }, 100);
        }

        // 关闭IM聊天窗口
        function closeIMChat() {
            const modal = document.getElementById('imChatModal');
            
            // 隐藏弹窗（向下滑出）
            modal.classList.remove('translate-y-0');
            modal.classList.add('translate-y-full');
            
            // 恢复底层页面滚动
            document.body.style.overflow = '';
        }

        // 发送IM消息
        function sendIMMessage() {
            const input = document.getElementById('imMessageInput');
            const message = input.value.trim();
            
            if (!message) {
                showToast('请输入消息内容');
                return;
            }
            
            // 创建消息元素
            const messageList = document.getElementById('imMessageList');
            const messageEl = document.createElement('div');
            messageEl.className = 'flex gap-2 mb-4 justify-end';
            
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            messageEl.innerHTML = `
                <div class="flex-1 max-w-[70%] flex flex-col items-end">
                    <div class="bg-gradient-to-br from-[#8E4337] to-[#6E2F25] rounded-2xl rounded-tr-sm px-4 py-3 shadow-sm">
                        <p class="text-white text-sm leading-relaxed">${message}</p>
                    </div>
                    <span class="text-[#9CA3AF] text-xs mr-2 mt-1">${timeStr}</span>
                </div>
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 bg-gradient-to-br from-[#8E4337] to-[#6E2F25] flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="w-5 h-5">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
            `;
            
            // 添加到消息列表
            messageList.appendChild(messageEl);
            
            // 清空输入框
            input.value = '';
            input.style.height = 'auto';
            
            // 滚动到底部
            messageList.scrollTop = messageList.scrollHeight;
            
            showToast('消息已发送');
        }

        // 输入框自动调整高度
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('imMessageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
                
                // 支持Enter发送，Shift+Enter换行
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendIMMessage();
                    }
                });
            }
        });

        // 跳转到开方页面
        function goToPrescription(consultationId) {
            showToast('正在跳转到开方页面...');
            setTimeout(() => {
                window.location.href = 'prescription-create.html';
            }, 500);
        }


        // 打开模态弹窗
        function openModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('show');
            
            // 聚焦到确认按钮
            setTimeout(() => {
                document.getElementById('modalConfirmBtn').focus();
            }, 100);
            
            // 点击遮罩层关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            };
        }

        // 关闭模态弹窗
        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
        }

        // 结束问诊（使用共享工具库）
        function endConsultation(consultationId) {
            // 使用共享工具库生成表单HTML（包含四诊信息）
            document.getElementById('modalMessage').innerHTML = generateEndConsultationForm(true);
            
            openModal();
            
            // 绑定确认按钮点击事件
            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.onclick = function() {
                // 使用共享工具库验证表单
                const validation = validateEndConsultationForm(true);
                
                if (!validation.valid) {
                    showToast(validation.message);
                    return;
                }
                
                // 保存问诊数据（实际应用中会发送到服务器）
                console.log('问诊数据:', validation.data);
                
                closeModal();
                showToast('正在结束问诊...');
                
                setTimeout(() => {
                    showToast('问诊已结束 ✓');
                    
                    // 询问是否需要开处方
                    setTimeout(() => {
                        showPrescriptionModal(consultationId);
                    }, 1000);
                }, 1200);
            };
        }

        // 询问是否开处方弹窗
        function showPrescriptionModal(consultationId) {
            const modalIcon = document.getElementById('modalIcon');
            modalIcon.className = 'w-12 h-12 rounded-full bg-[#FFF7ED] flex items-center justify-center mx-auto mb-4';
            modalIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EA580C" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M10.5 3.75a6 6 0 00-5.98 6.496A5.25 5.25 0 006.75 20.25H18a4.5 4.5 0 002.206-8.423 3.75 3.75 0 00-4.133-4.303A6.001 6.001 0 0010.5 3.75zm2.03 5.47a.75.75 0 00-1.06 0l-3 3a.75.75 0 101.06 1.06l1.72-1.72v4.94a.75.75 0 001.5 0v-4.94l1.72 1.72a.75.75 0 101.06-1.06l-3-3z" clip-rule="evenodd" />
                </svg>
            `;
            
            document.getElementById('modalTitle').textContent = '处方开具';
            document.getElementById('modalMessage').innerHTML = `
                <p class="text-center">是否需要为患者开具处方？</p>
            `;
            
            // 更新为两个按钮
            document.getElementById('modalButtons').innerHTML = `
                <button 
                    class="py-3 border-2 border-[#E5E7EB] rounded-lg text-[#6B7280] text-sm font-medium cursor-pointer hover:bg-[#F9FAFB] transition-colors active:scale-98"
                    onclick="handlePrescriptionLater()"
                    aria-label="稍后开方">
                    稍后开方
                </button>
                <button 
                    class="py-3 bg-[#8E4337] rounded-lg text-white text-sm font-medium cursor-pointer hover:bg-[#6E2F25] transition-colors active:scale-98"
                    onclick="handlePrescriptionNow('${consultationId}')"
                    aria-label="立即开方">
                    立即开方
                </button>
            `;
            
            openModal();
        }
        
        // 立即开方
        function handlePrescriptionNow(consultationId) {
            closeModal();
            showToast('正在打开处方系统...');
            
            setTimeout(() => {
                window.location.href = 'prescription-create.html';
            }, 800);
        }
        
        // 稍后开方
        function handlePrescriptionLater() {
            closeModal();
            showToast('已记录，可稍后开方');
        }
    </script>
</body>
</html>

