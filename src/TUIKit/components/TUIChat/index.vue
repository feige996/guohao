<script lang="ts" setup>
import type {
  IConversationModel,
  IMessageModel,
} from '@tencentcloud/chat-uikit-engine'
import type { ExtensionInfo } from '@tencentcloud/tui-core'
import type { ToolbarDisplayType } from '../../interface'
// @Start uniapp use Chat only
import { onLoad, onUnload } from '@dcloudio/uni-app'
import TUIChatEngine, {
  StoreName,
  TUIConversationService,
  TUIStore,
  TUITranslateService,
} from '@tencentcloud/chat-uikit-engine'
import TUICore, { TUIConstants } from '@tencentcloud/tui-core'
import { computed, onMounted, onUnmounted, ref } from '../../adapter-vue'
import { isApp, isMobile, isPC, isUniFrameWork, isWeChat } from '../../utils/env'
import ChatHeader from './chat-header/index.vue'
import TUIChatConfig from './config'
import { initChat, logout } from './entry-chat-only.ts'
import Forward from './forward/index.vue'
import MessageInputToolbar from './message-input-toolbar/index.vue'
import MessageInput from './message-input/index.vue'

import MessageList from './message-list/index.vue'
import MultipleSelectPanel from './mulitple-select-panel/index.vue'

// @End uniapp use Chat only

const emits = defineEmits(['closeChat'])

onLoad((options) => {
  initChat(options)
})

onUnload(() => {
  // Whether logout is decided by yourself  when the page is unloaded. The default is false.
  logout(false).then(() => {
    // Handle success result from promise.then when you set true.
  }).catch(() => {
    // handle error
  })
})
const groupID = ref(undefined)
const isGroup = ref(false)
const isNotInGroup = ref(false)
const notInGroupReason = ref<number>()
const currentConversationID = ref()
const isMultipleSelectMode = ref(false)
const inputToolbarDisplayType = ref<ToolbarDisplayType>('none')
const messageInputRef = ref()
const messageListRef = ref<InstanceType<typeof MessageList>>()
const headerExtensionList = ref<ExtensionInfo[]>([])
const featureConfig = TUIChatConfig.getFeatureConfig()
const chatHeight = ref('100vh')
onMounted(() => {
  TUIStore.watch(StoreName.CONV, {
    currentConversation: onCurrentConversationUpdate,
  })

  // 设置窗口高度CSS变量，解决导航栏高度问题
  // if (isUniFrameWork) {
  //   try {
  //     // 获取系统信息
  //     const systemInfo = uni.getSystemInfoSync()
  //     const windowHeight = systemInfo.windowHeight

  //     if (windowHeight) {
  //       // 设置CSS变量到根元素，确保全局可用
  //       document.documentElement.style.setProperty('--window-height', `${windowHeight}px`)

  //       // 也可以直接设置到页面元素
  //       setTimeout(() => {
  //         const chatElement = document.querySelector('.chat') as HTMLElement
  //         if (chatElement) {
  //           chatElement.style.height = `${windowHeight}px`
  //         }
  //       }, 0)
  //     }
  //   }
  //   catch (error) {
  //     console.warn('获取系统信息失败:', error)
  //     // 降级方案：使用100%高度
  //     document.documentElement.style.setProperty('--window-height', '100%')
  //   }
  // }

  try {
    const systemInfo = uni.getSystemInfoSync()
    chatHeight.value = `${systemInfo.windowHeight}px`
  }
  catch (error) {
    console.warn('获取系统信息失败:', error)
  }
})

onUnmounted(() => {
  TUIStore.unwatch(StoreName.CONV, {
    currentConversation: onCurrentConversationUpdate,
  })
  reset()
})

const isInputToolbarShow = computed<boolean>(() => {
  return isUniFrameWork ? inputToolbarDisplayType.value !== 'none' : true
})

const leaveGroupReasonText = computed<string>(() => {
  let text = ''
  switch (notInGroupReason.value) {
    case 4:
      text = TUITranslateService.t('TUIChat.您已被管理员移出群聊')
      break
    case 5:
      text = TUITranslateService.t('TUIChat.该群聊已被解散')
      break
    case 8:
      text = TUITranslateService.t('TUIChat.您已退出该群聊')
      break
    default:
      text = TUITranslateService.t('TUIChat.您已退出该群聊')
      break
  }
  return text
})

function reset() {
  TUIConversationService.switchConversation('')
}

function closeChat(conversationID: string) {
  emits('closeChat', conversationID)
  reset()
}

function insertEmoji(emojiObj: object) {
  messageInputRef.value?.insertEmoji(emojiObj)
}

function handleEditor(message: IMessageModel, type: string) {
  if (!message || !type)
    return
  switch (type) {
    case 'reference':
      // todo
      break
    case 'reply':
      // todo
      break
    case 'reedit':
      if (message?.payload?.text) {
        messageInputRef?.value?.reEdit(message?.payload?.text)
      }
      break
    default:
      break
  }
}

function handleGroup() {
  headerExtensionList.value[0].listener.onClicked({ groupID: groupID.value })
}

function changeToolbarDisplayType(type: ToolbarDisplayType) {
  inputToolbarDisplayType.value = inputToolbarDisplayType.value === type ? 'none' : type
  if (inputToolbarDisplayType.value !== 'none' && isUniFrameWork) {
    uni.$emit('scroll-to-bottom')
  }
}

function scrollToLatestMessage() {
  messageListRef.value?.scrollToLatestMessage()
}

function toggleMultipleSelectMode(visible?: boolean) {
  isMultipleSelectMode.value = visible === undefined ? !isMultipleSelectMode.value : visible
}

function mergeForwardMessage() {
  messageListRef.value?.mergeForwardMessage()
}

function oneByOneForwardMessage() {
  messageListRef.value?.oneByOneForwardMessage()
}

function updateUIUserNotInGroup(conversation: IConversationModel) {
  if (conversation?.operationType > 0) {
    headerExtensionList.value = []
    isNotInGroup.value = true
    /**
     * 4 - be removed from the group
     * 5 - group is dismissed
     * 8 - quit group
     */
    notInGroupReason.value = conversation?.operationType
  }
  else {
    isNotInGroup.value = false
    notInGroupReason.value = undefined
  }
}

function onCurrentConversationUpdate(conversation: IConversationModel) {
  updateUIUserNotInGroup(conversation)
  // return when currentConversation is null
  if (!conversation) {
    return
  }
  // return when currentConversationID.value is the same as conversation.conversationID.
  if (currentConversationID.value === conversation?.conversationID) {
    return
  }

  isGroup.value = false
  let conversationType = TUIChatEngine.TYPES.CONV_C2C
  const conversationID = conversation.conversationID
  if (conversationID.startsWith(TUIChatEngine.TYPES.CONV_GROUP)) {
    conversationType = TUIChatEngine.TYPES.CONV_GROUP
    isGroup.value = true
    groupID.value = conversationID.replace(TUIChatEngine.TYPES.CONV_GROUP, '')
  }

  headerExtensionList.value = []
  isMultipleSelectMode.value = false
  // Initialize chatType
  TUIChatConfig.setChatType(conversationType)
  // While converstaion change success, notify callkit and roomkit、or other components.
  TUICore.notifyEvent(TUIConstants.TUIChat.EVENT.CHAT_STATE_CHANGED, TUIConstants.TUIChat.EVENT_SUB_KEY.CHAT_OPENED, { groupID: groupID.value })
  // The TUICustomerServicePlugin plugin determines if the current conversation is a customer service conversation, then sets chatType and activates the conversation.
  TUICore.callService({
    serviceName: TUIConstants.TUICustomerServicePlugin.SERVICE.NAME,
    method: TUIConstants.TUICustomerServicePlugin.SERVICE.METHOD.ACTIVE_CONVERSATION,
    params: { conversationID },
  })
  // When open chat in room, close main chat ui and reset theme.
  if (TUIChatConfig.getChatType() === TUIConstants.TUIChat.TYPE.ROOM) {
    if (TUIChatConfig.getFeatureConfig(TUIConstants.TUIChat.FEATURE.InputVoice) === true) {
      TUIChatConfig.setTheme('light')
      currentConversationID.value = ''
      return
    }
  }
  // Get chat header extensions
  if (TUIChatConfig.getChatType() === TUIConstants.TUIChat.TYPE.GROUP) {
    headerExtensionList.value = TUICore.getExtensionList(TUIConstants.TUIChat.EXTENSION.CHAT_HEADER.EXT_ID)
  }
  TUIStore.update(StoreName.CUSTOM, 'activeConversation', conversationID)
  currentConversationID.value = conversationID
}
</script>

<template>
  <view class="chat" :style="{ height: chatHeight }">
    <div class="tui-chat" :class="[!isPC && 'tui-chat-h5']">
      <div
        v-if="!currentConversationID"
        class="tui-chat-default" :class="[!isPC && 'tui-chat-h5-default']"
      >
        <slot />
      </div>
      <div
        v-if="currentConversationID"
        class="tui-chat" :class="[!isPC && 'tui-chat-h5']"
      >
        <ChatHeader
          class="tui-chat-header" :class="[
            !isPC && 'tui-chat-H5-header',
            isUniFrameWork && 'tui-chat-uniapp-header',
          ]"
          :is-group="isGroup"
          :header-extension-list="headerExtensionList"
          @close-chat="closeChat"
          @open-group-management="handleGroup"
        />
        <Forward @toggle-multiple-select-mode="toggleMultipleSelectMode" />
        <MessageList
          ref="messageListRef"
          class="tui-chat-message-list" :class="[!isPC && 'tui-chat-h5-message-list']"
          :is-group="isGroup"
          :group-i-d="groupID"
          :is-not-in-group="isNotInGroup"
          :is-multiple-select-mode="isMultipleSelectMode"
          @handle-editor="handleEditor"
          @close-input-tool-bar="() => changeToolbarDisplayType('none')"
          @toggle-multiple-select-mode="toggleMultipleSelectMode"
        />
        <div
          v-if="isNotInGroup"
          class="tui-chat-leave-group" :class="{
            'tui-chat-leave-group-mobile': isMobile,
          }"
        >
          {{ leaveGroupReasonText }}
        </div>
        <MultipleSelectPanel
          v-else-if="isMultipleSelectMode"
          @one-by-one-forward-message="oneByOneForwardMessage"
          @merge-forward-message="mergeForwardMessage"
          @toggle-multiple-select-mode="toggleMultipleSelectMode"
        />
        <template v-else>
          <MessageInputToolbar
            v-if="isInputToolbarShow"
            class="tui-chat-message-input-toolbar" :class="[
              !isPC && 'tui-chat-h5-message-input-toolbar',
              isUniFrameWork && 'tui-chat-uni-message-input-toolbar',
            ]"
            :display-type="inputToolbarDisplayType"
            @insert-emoji="insertEmoji"
            @change-toolbar-display-type="changeToolbarDisplayType"
            @scroll-to-latest-message="scrollToLatestMessage"
          />
          <MessageInput
            ref="messageInputRef"
            class="tui-chat-message-input" :class="[
              !isPC && 'tui-chat-h5-message-input',
              isUniFrameWork && 'tui-chat-uni-message-input',
              isWeChat && 'tui-chat-wx-message-input',
            ]"
            :enable-at="featureConfig.InputMention"
            :is-muted="false"
            :mute-text="TUITranslateService.t('TUIChat.您已被管理员禁言')"
            :placeholder="TUITranslateService.t('TUIChat.请输入消息')"
            :input-toolbar-display-type="inputToolbarDisplayType"
            @change-toolbar-display-type="changeToolbarDisplayType"
          />
        </template>
      </div>
      <!-- Group Management -->
      <div
        v-if="!isNotInGroup && !isApp && isUniFrameWork && isGroup && headerExtensionList.length > 0"
        class="group-profile"
        @click="handleGroup"
      >
        {{ headerExtensionList[0].text }}
      </div>
    </div>
  </view>
</template>

<style scoped lang="scss" src="./style/index.scss"></style>
