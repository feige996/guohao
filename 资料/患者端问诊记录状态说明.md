在线问诊订单状态流程完整说明

## 1. 状态码全局定义表

### 1.1 状态码编号规则

- **1xx**: 支付相关状态
- **2xx**: 派单模式专属状态
- **3xx**: 坐诊模式专属状态
- **4xx**: 问诊服务状态（通用）
- **5xx**: 退款相关状态
- **9xx**: 终止状态

### 1.2 完整状态码定义

| 状态码 | 状态名称 | 英文常量 | 适用模式 | 说明 |
|--------|----------|----------|----------|------|
| **100** | 待支付 | PENDING_PAYMENT | 通用 | 订单创建但未支付 |
| **101** | 支付中 | PAYING | 通用 | 用户已提交支付，等待结果 |
| **102** | 支付失败 | PAYMENT_FAILED | 通用 | 支付失败，可重试支付 |
| **200** | 派单中 | DISPATCHING | 派单专用 | 支付成功，系统正在派单 |
| **201** | 待接单 | PENDING_ACCEPT | 派单专用 | 派单完成，等待医生接单 |
| **202** | 派单失败 | DISPATCH_FAILED | 派单专用 | 无可用医生，派单失败 |
| **300** | 取号中 | QUEUING_NUMBER | 坐诊专用 | 支付成功，系统正在取号 |
| **301** | 预约待生效 | PENDING_ACTIVATION | 坐诊专用 | 已预约，等待医生开诊 |
| **302** | 排队中 | IN_QUEUE | 坐诊专用 | 医生开诊，进入排队队列 |
| **303** | 叫号中 | CALLING | 坐诊专用 | 医生叫号，等待患者响应 |
| **304** | 叫号失败 | CALL_FAILED | 坐诊专用 | 3次叫号失败，部分退款 |
| **305** | 过号重排 | RE_QUEUING | 坐诊专用 | 叫号未应答，重新排队 |
| **400** | 待接诊 | PENDING_CONSULTATION | 通用 | 医患准备就绪，等待开始 |
| **401** | 进行中 | IN_PROGRESS | 通用 | 问诊进行中 |
| **402** | 服务超时 | SERVICE_TIMEOUT | 通用 | 问诊超时未完成 |
| **500** | 退款申请中 | REFUND_REQUESTED | 通用 | 用户提交退款申请 |
| **501** | 退款审核中 | REFUND_REVIEWING | 通用 | 系统审核退款申请 |
| **502** | 退款处理中 | REFUNDING | 通用 | 退款申请通过，处理中 |
| **503** | 退款失败 | REFUND_FAILED | 通用 | 退款处理失败 |
| **900** | 已完成 | COMPLETED | 通用 | 问诊正常结束 |
| **901** | 已退款 | REFUNDED | 通用 | 退款完成 |
| **902** | 已取消 | CANCELLED | 通用 | 用户取消或系统超时取消 |

## 2. 派单模式详细说明

### 2.1 派单模式完整流程

```
正常流程：
待支付(100) → 支付中(101) → 派单中(200) → 待接单(201) → 待接诊(400) → 进行中(401) → 已完成(900)

异常分支：
• 支付失败：支付中(101) → 支付失败(102) → 待支付(100) 或 已取消(902)
• 派单失败：派单中(200) → 派单失败(202) → 退款处理中(502) → 已退款(901)
• 接单超时：待接单(201) → [超时5分钟] → 退款处理中(502) → 已退款(901)
• 用户取消：任意状态 → 退款申请中(500) → 退款审核中(501) → 退款处理中(502) → 已退款(901)
```

### 2.2 派单模式状态详细说明

#### 100. 待支付 (PENDING_PAYMENT)
- **说明**：订单创建成功，等待用户完成支付操作
- **用户操作**：可选择支付或取消订单
- **超时规则**：30分钟未支付自动取消
- **下一状态**：
  - 用户提交支付 → 支付中(101)
  - 用户取消 → 已取消(902)
  - 超时 → 已取消(902)

#### 101. 支付中 (PAYING)
- **说明**：用户已提交支付请求，系统等待支付网关返回结果
- **作用**：防止重复支付，确保支付状态准确
- **超时规则**：支付网关响应超时（通常2-5分钟）
- **下一状态**：
  - 支付成功 → 派单中(200)
  - 支付失败 → 支付失败(102)
  - 超时 → 支付失败(102)

#### 102. 支付失败 (PAYMENT_FAILED)
- **说明**：支付处理失败，用户可重新尝试支付
- **失败原因**：余额不足、银行卡限额、网络异常等
- **用户操作**：可重新支付或取消订单
- **下一状态**：
  - 重新支付 → 支付中(101)
  - 用户取消 → 已取消(902)
  - 30分钟未操作 → 已取消(902)

#### 200. 派单中 (DISPATCHING)
- **说明**：支付成功，系统正在智能分配合适的医生
- **业务流程**：根据科室、医生在线状态、专业领域、接单率等条件匹配
- **可取消退款**：支持用户取消并全额退款
- **超时规则**：派单逻辑执行时间（通常1-3分钟）
- **下一状态**：
  - 派单成功 → 待接单(201)
  - 无可用医生 → 派单失败(202)
  - 用户取消 → 退款申请中(500)

#### 202. 派单失败 (DISPATCH_FAILED)
- **说明**：系统无法找到合适的医生接单
- **失败原因**：无在线医生、医生全部拒单、系统异常等
- **处理方式**：自动全额退款
- **下一状态**：退款处理中(502) → 已退款(901)

#### 201. 待接单 (PENDING_ACCEPT)
- **说明**：系统已分配具体医生，等待医生确认接诊
- **医生操作**：医生有5分钟时间决定是否接诊
- **可取消退款**：支持用户取消并全额退款
- **超时规则**：5分钟未接诊自动重新派单或退款
- **下一状态**：
  - 医生接单 → 待接诊(400)
  - 医生拒单 → 派单中(200，重新派单)
  - 超时未接 → 派单中(200，重新派单) 或 退款处理中(502)
  - 用户取消 → 退款申请中(500)

#### 400. 待接诊 (PENDING_CONSULTATION)
- **说明**：医生已接单，医患双方准备就绪，等待开始问诊
- **业务流程**：系统建立问诊连接，准备音视频通话
- **超时规则**：医生有2分钟准备时间开始问诊
- **下一状态**：
  - 医生开始问诊 → 进行中(401)
  - 超时未开始 → 退款申请中(500，扣除基础服务费）
  - 用户取消 → 退款申请中(500，扣除基础服务费）
  - 医生异常 → 退款处理中(502，全额退款）

#### 401. 进行中 (IN_PROGRESS)
- **说明**：问诊服务正式开始，医患双方正在进行交流
- **功能支持**：文字、图片、语音、视频等多种问诊形式
- **持续时间**：根据问诊类型而定（通常15-30分钟）
- **结束条件**：
  - 医生点击"结束问诊"
  - 双方无交互超过30分钟 → 服务超时(402)
- **下一状态**：
  - 正常结束 → 已完成(900)
  - 服务超时 → 服务超时(402) → 已完成(900)
  - 异常中断 → 退款申请中(500，按时长比例退款）

#### 402. 服务超时 (SERVICE_TIMEOUT)
- **说明**：问诊过程中长时间无交互，系统自动结束
- **处理方式**：按实际服务时长计费，自动结束问诊
- **下一状态**：已完成(900)

#### 900. 已完成 (COMPLETED)
- **说明**：问诊服务正常结束，生成问诊记录
- **后续操作**：患者可评价、查看处方、查看报告
- **状态特性**：最终状态，不可逆转

### 2.3 派单模式退款规则

| 取消时机 | 退款比例 | 处理时效 | 说明 |
|---------|---------|---------|------|
| 待支付取消 | 无需退款 | 立即 | 未产生费用 |
| 派单中取消 | 100%全额 | 1-3个工作日 | 服务未开始 |
| 待接单取消 | 100%全额 | 1-3个工作日 | 服务未开始 |
| 待接诊取消 | 扣除10%服务费 | 3-5个工作日 | 已占用医生资源 |
| 进行中取消 | 按时长比例 | 5-7个工作日 | 已提供部分服务 |
| 派单失败 | 100%全额 | 1个工作日 | 系统原因 |
| 医生异常 | 100%全额 | 1个工作日 | 医生原因 |

## 3. 坐诊模式详细说明

### 3.1 坐诊模式完整流程

```
正常流程：
待支付(100) → 支付中(101) → 取号中(300) → 预约待生效(301) → 排队中(302) → 叫号中(303) → 待接诊(400) → 进行中(401) → 已完成(900)

即时就诊流程（医生已开诊）：
待支付(100) → 支付中(101) → 取号中(300) → 排队中(302) → 叫号中(303) → 待接诊(400) → 进行中(401) → 已完成(900)

异常分支：
• 支付失败：支付中(101) → 支付失败(102) → 待支付(100) 或 已取消(902)
• 叫号失败：叫号中(303) → [3次未应答] → 叫号失败(304) → 退款处理中(502) → 已退款(901)
• 过号重排：叫号中(303) → [首次未应答] → 过号重排(305) → 排队中(302)
• 医生停诊：预约待生效(301)/排队中(302) → 退款处理中(502) → 已退款(901)
• 用户取消：任意状态 → 退款申请中(500) → 退款审核中(501) → 退款处理中(502) → 已退款(901)
```

### 3.2 坐诊模式状态详细说明

#### 100. 待支付 (PENDING_PAYMENT)
- **说明**：患者选择医生和问诊时间，创建预约订单
- **特性**：支持提前预约（最长可预约7天内）
- **超时规则**：30分钟未支付自动取消
- **下一状态**：
  - 用户提交支付 → 支付中(101)
  - 用户取消 → 已取消(902)
  - 超时 → 已取消(902)

#### 101. 支付中 (PAYING)
- **说明**：同派单模式，支付处理中间状态
- **下一状态**：
  - 支付成功 → 取号中(300)
  - 支付失败 → 支付失败(102)

#### 102. 支付失败 (PAYMENT_FAILED)
- **说明**：同派单模式，支付失败可重试
- **下一状态**：
  - 重新支付 → 支付中(101)
  - 用户取消 → 已取消(902)

#### 300. 取号中 (QUEUING_NUMBER)
- **说明**：支付成功，系统正在执行取号操作
- **业务流程**：生成排队号码，分配就诊序号
- **超时规则**：取号操作执行时间（通常1分钟内）
- **下一状态**：
  - 医生已开诊 → 排队中(302)
  - 医生未开诊 → 预约待生效(301)
  - 取号失败 → 退款处理中(502)

#### 301. 预约待生效 (PENDING_ACTIVATION)
- **说明**：预约成功，但医生尚未开诊，等待问诊时间段开始
- **患者提示**："预约成功，等待医生开诊"
- **特性**：区分预约期和执行期，提升体验
- **可取消退款**：支持用户取消并全额退款
- **下一状态**：
  - 医生开诊 → 排队中(302)
  - 医生停诊 → 退款处理中(502)
  - 用户取消 → 退款申请中(500)
  - 超过预约时间15分钟 → 已取消(902)

#### 302. 排队中 (IN_QUEUE)
- **说明**：医生已开诊，患者进入实时排队队列
- **排队信息**：显示当前排队位置、预计等待时间
- **队列更新**：实时更新排队进度
- **可取消退款**：支持用户取消并全额退款
- **下一状态**：
  - 医生叫号 → 叫号中(303)
  - 医生停诊 → 退款处理中(502)
  - 用户取消 → 退款申请中(500)

#### 303. 叫号中 (CALLING)
- **说明**：医生呼叫患者，等待患者响应并进入问诊室
- **叫号规则**：每次叫号等待2分钟，最多3次叫号
- **患者通知**：APP推送、短信提醒、语音呼叫
- **下一状态**：
  - 患者应答 → 待接诊(400)
  - 首次未应答 → 过号重排(305)
  - 3次均未应答 → 叫号失败(304)
  - 用户取消 → 退款申请中(500)

#### 305. 过号重排 (RE_QUEUING)
- **说明**：患者首次叫号未应答，顺延3位后重新排队
- **业务规则**：给予患者第二次机会，避免直接失败
- **处理方式**：自动将患者排到当前队列后第3位
- **下一状态**：排队中(302)

#### 304. 叫号失败 (CALL_FAILED)
- **说明**：3次叫号患者均未应答，问诊失败
- **退款规则**：部分退款（扣除20%预约服务费）
- **下一状态**：退款处理中(502) → 已退款(901)

#### 400. 待接诊 (PENDING_CONSULTATION)
- **说明**：患者应答叫号，准备开始问诊
- **业务流程**：同派单模式，医患双方确认准备就绪
- **超时规则**：医生有2分钟准备时间开始问诊
- **下一状态**：
  - 医生开始问诊 → 进行中(401)
  - 超时未开始 → 退款申请中(500)
  - 医生异常 → 退款处理中(502)

#### 401. 进行中 (IN_PROGRESS)
- **说明**：同派单模式，问诊服务进行中
- **下一状态**：
  - 正常结束 → 已完成(900)
  - 服务超时 → 服务超时(402) → 已完成(900)

#### 402. 服务超时 (SERVICE_TIMEOUT)
- **说明**：同派单模式，问诊超时自动结束
- **下一状态**：已完成(900)

#### 900. 已完成 (COMPLETED)
- **说明**：同派单模式，问诊正常结束

### 3.3 坐诊模式特殊规则

| 规则类型 | 规则说明 | 处理方式 |
|---------|---------|---------|
| **预约时间** | 支持精确到时间段的预约（如9:00-10:00） | 提前预约最长7天 |
| **过号处理** | 首次叫号未应答 | 顺延3位后重新排队(305) |
| **叫号失败** | 3次叫号均未应答 | 扣除20%服务费后退款 |
| **迟到处理** | 超过预约时间15分钟未到 | 自动取消预约，不退款 |
| **医生停诊** | 医生临时停诊 | 全额退款 |
| **提前取消** | 预约待生效期间取消 | 全额退款 |
| **排队取消** | 排队中取消 | 扣除10%服务费后退款 |

### 3.4 坐诊模式退款规则

| 取消时机 | 退款比例 | 处理时效 | 说明 |
|---------|---------|---------|------|
| 待支付取消 | 无需退款 | 立即 | 未产生费用 |
| 预约待生效取消 | 100%全额 | 1-3个工作日 | 服务未开始 |
| 排队中取消 | 扣除10%服务费 | 3-5个工作日 | 已占用排队资源 |
| 叫号中取消 | 扣除15%服务费 | 3-5个工作日 | 已占用医生时间 |
| 待接诊取消 | 扣除20%服务费 | 3-5个工作日 | 已占用医生资源 |
| 进行中取消 | 按时长比例 | 5-7个工作日 | 已提供部分服务 |
| 叫号失败 | 扣除20%服务费 | 3个工作日 | 患者原因 |
| 医生停诊 | 100%全额 | 1个工作日 | 医生原因 |
| 迟到超时 | 不退款 | - | 患者原因 |

## 4. 两种模式结合与对比

### 4.1 业务流程结合点

#### 共同开始流程（支付阶段）
```
待支付(100) → 支付中(101) → [支付成功]
                          ↓ [支付失败]
                     支付失败(102) → 待支付(100) 或 已取消(902)
```

#### 共同服务流程（问诊阶段）
```
待接诊(400) → 进行中(401) → 已完成(900)
                        ↓ [超时]
                   服务超时(402) → 已完成(900)
```

#### 统一退款流程
```
退款申请中(500) → 退款审核中(501) → 退款处理中(502) → 已退款(901)
                                                  ↓ [失败]
                                            退款失败(503) → 退款处理中(502)
```

### 4.2 模式对比分析

| 对比维度 | 派单模式 | 坐诊模式 |
|---------|---------|---------|
| **适用场景** | 紧急咨询、普通问诊 | 预约制、专科问诊 |
| **医生分配** | 系统智能匹配 | 患者自主选择 |
| **等待方式** | 等待医生接单 | 排队等待叫号 |
| **时间确定性** | 不确定性较高 | 时间相对确定 |
| **用户体验** | 快速便捷 | 计划性强 |
| **医生资源利用** | 资源池共享 | 专属医生时段 |
| **核心状态** | 派单中(200)、待接单(201) | 取号中(300)、排队中(302)、叫号中(303) |
| **失败处理** | 派单失败自动退款 | 叫号失败部分退款 |
| **取消灵活性** | 接单前可全额退款 | 开诊前可全额退款 |

### 4.3 简洁业务流程总结

#### 派单模式核心路径
```
创建订单 → 立即支付 → 智能派单 → 医生接单 → 医生接诊 → 开始问诊 → 服务结束
  100   →   101   →   200   →   201   →   400   →   401   →   900
```

#### 坐诊模式核心路径
```
预约订单 → 提前支付 → 按时取号 → 排队等待 → 医生叫号 → 患者应答 → 开始问诊 → 服务结束
  100   →   101   →   300   →   302   →   303   →   400   →   401   →   900
```

#### 核心业务抽象
```
订单创建 → 支付验证 → 服务准备 → 医患匹配 → 问诊执行 → 服务结束
  100   →   101   → 2xx/3xx →   400   →   401   →   900
```

## 5. 退款流程详细说明

### 5.1 退款状态流转

#### 500. 退款申请中 (REFUND_REQUESTED)
- **说明**：用户主动提交退款申请或系统触发退款
- **触发条件**：
  - 用户主动取消订单
  - 服务异常需要退款
  - 超时自动触发退款
- **下一状态**：退款审核中(501)

#### 501. 退款审核中 (REFUND_REVIEWING)
- **说明**：系统自动审核退款申请，判断退款比例
- **审核规则**：
  - 根据订单状态判断退款比例
  - 检查是否符合退款条件
  - 计算实际退款金额
- **审核时效**：自动审核（1-5分钟）
- **下一状态**：
  - 审核通过 → 退款处理中(502)
  - 审核拒绝 → 原状态（保留订单）

#### 502. 退款处理中 (REFUNDING)
- **说明**：退款申请通过，正在处理退款到账
- **处理流程**：调用支付网关退款接口
- **处理时效**：1-7个工作日（取决于支付渠道）
- **下一状态**：
  - 退款成功 → 已退款(901)
  - 退款失败 → 退款失败(503)

#### 503. 退款失败 (REFUND_FAILED)
- **说明**：退款处理失败，需要人工介入
- **失败原因**：
  - 支付网关异常
  - 账户信息错误
  - 银行卡状态异常
- **处理方式**：系统自动重试3次，失败后转人工处理
- **下一状态**：
  - 重试成功 → 退款处理中(502)
  - 转人工处理 → 退款处理中(502)

#### 901. 已退款 (REFUNDED)
- **说明**：退款成功到账，订单结束
- **状态特性**：最终状态，不可逆转

### 5.2 退款比例计算规则

| 订单状态 | 派单模式退款比例 | 坐诊模式退款比例 | 说明 |
|---------|----------------|----------------|------|
| 待支付(100) | 无需退款 | 无需退款 | 未支付 |
| 支付中(101) | 100% | 100% | 支付未完成 |
| 派单中(200) | 100% | - | 服务未开始 |
| 待接单(201) | 100% | - | 服务未开始 |
| 派单失败(202) | 100% | - | 系统原因 |
| 取号中(300) | - | 100% | 服务未开始 |
| 预约待生效(301) | - | 100% | 服务未开始 |
| 排队中(302) | - | 90% | 已占用资源 |
| 叫号中(303) | - | 85% | 已占用资源 |
| 叫号失败(304) | - | 80% | 患者原因 |
| 待接诊(400) | 90% | 80% | 已占用医生 |
| 进行中(401) | 按时长比例 | 按时长比例 | 已提供服务 |
| 医生异常 | 100% | 100% | 医生原因 |
| 系统异常 | 100% | 100% | 系统原因 |

### 5.3 进行中退款时长比例

| 服务时长 | 退款比例 | 说明 |
|---------|---------|------|
| 0-5分钟 | 80% | 刚开始服务 |
| 6-10分钟 | 60% | 服务进行中 |
| 11-15分钟 | 40% | 服务大半 |
| 16-20分钟 | 20% | 接近完成 |
| 20分钟以上 | 0% | 服务已完成 |

## 6. 异常处理与状态管理

### 6.1 超时规则统一管理

| 超时类型 | 超时时长 | 适用模式 | 超时后处理 |
|---------|---------|---------|-----------|
| **支付超时** | 30分钟 | 通用 | 自动取消(902) |
| **支付网关超时** | 5分钟 | 通用 | 支付失败(102) |
| **派单超时** | 3分钟 | 派单模式 | 派单失败(202) → 全额退款 |
| **接单超时** | 5分钟 | 派单模式 | 重新派单或退款 |
| **待接诊超时** | 2分钟 | 通用 | 退款申请(500) |
| **叫号超时** | 2分钟×3次 | 坐诊模式 | 叫号失败(304) → 部分退款 |
| **问诊超时** | 30-60分钟 | 通用 | 服务超时(402) → 完成(900) |
| **迟到超时** | 15分钟 | 坐诊模式 | 取消预约(902)，不退款 |

### 6.2 异常场景处理策略

#### 6.2.1 支付异常

| 异常场景 | 处理策略 | 状态流转 |
|---------|---------|---------|
| **支付回调丢失** | 主动查询支付结果，补偿更新状态 | 支付中(101) → 查询确认 |
| **重复支付** | 支付中状态锁定，拒绝重复请求 | 保持支付中(101) |
| **支付金额不符** | 拒绝订单，全额退款 | → 退款处理中(502) |
| **支付渠道异常** | 标记支付失败，允许重试 | → 支付失败(102) |

#### 6.2.2 医生端异常

| 异常场景 | 处理策略 | 状态流转 |
|---------|---------|---------|
| **医生接单后离线** | 等待2分钟，超时自动退款 | 待接诊(400) → 退款(502) |
| **医生问诊中断线** | 保留问诊记录，按时长退款 | 进行中(401) → 退款申请(500) |
| **医生拒单** | 自动重新派单（最多3次） | 待接单(201) → 派单中(200) |
| **医生停诊** | 自动取消预约，全额退款 | 预约待生效(301) → 退款(502) |

#### 6.2.3 患者端异常

| 异常场景 | 处理策略 | 状态流转 |
|---------|---------|---------|
| **患者支付后离线** | 订单正常流转，推送通知 | 正常流程 |
| **患者叫号未应答** | 首次过号重排，3次失败退款 | 叫号中(303) → 过号重排(305) |
| **患者问诊中断线** | 保留问诊状态，等待重连 | 保持进行中(401) |
| **患者恶意取消** | 按规则扣除服务费 | → 退款申请(500) |

#### 6.2.4 系统异常

| 异常场景 | 处理策略 | 状态流转 |
|---------|---------|---------|
| **派单系统故障** | 派单失败，全额退款 | 派单中(200) → 派单失败(202) |
| **取号系统故障** | 取号失败，全额退款 | 取号中(300) → 退款(502) |
| **音视频连接失败** | 重试3次，失败全额退款 | 待接诊(400) → 退款(502) |
| **数据库异常** | 状态回滚，保证一致性 | 回滚到上一状态 |

### 6.3 状态流转约束规则

#### 6.3.1 基本约束
1. **顺序性**：状态必须按业务流程顺序流转，不可跳跃
2. **不可逆性**：终止状态（900/901/902）不可逆转
3. **原子性**：状态变更必须原子操作，避免中间态
4. **一致性**：同一订单同一时间只能处于一个主要状态
5. **完整性**：每个状态都有明确的进入和退出条件

#### 6.3.2 状态转换矩阵

| 当前状态 | 允许转换到的状态 |
|---------|----------------|
| 100 待支付 | 101, 902 |
| 101 支付中 | 102, 200, 300 |
| 102 支付失败 | 100, 101, 902 |
| 200 派单中 | 201, 202, 500 |
| 201 待接单 | 200, 400, 500, 502 |
| 202 派单失败 | 502 |
| 300 取号中 | 301, 302, 502 |
| 301 预约待生效 | 302, 500, 502, 902 |
| 302 排队中 | 303, 500, 502 |
| 303 叫号中 | 304, 305, 400, 500 |
| 304 叫号失败 | 502 |
| 305 过号重排 | 302 |
| 400 待接诊 | 401, 500, 502 |
| 401 进行中 | 402, 500, 900 |
| 402 服务超时 | 900 |
| 500 退款申请中 | 501 |
| 501 退款审核中 | 502, 原状态 |
| 502 退款处理中 | 503, 901 |
| 503 退款失败 | 502 |
| 900 已完成 | 无（终止状态） |
| 901 已退款 | 无（终止状态） |
| 902 已取消 | 无（终止状态） |

### 6.4 状态持久化与审计

#### 6.4.1 状态变更日志
- **记录内容**：订单ID、原状态、新状态、变更时间、变更原因、操作人
- **存储要求**：永久保存，不可删除
- **查询性能**：建立索引，支持快速查询

#### 6.4.2 状态快照
- **快照时机**：每次状态变更时保存完整订单快照
- **保留期限**：至少保留1年
- **用途**：问题排查、数据恢复、审计追溯

#### 6.4.3 监控告警
- **异常状态监控**：长时间停留在中间状态
- **超时告警**：超过预期时长未流转
- **异常率监控**：退款率、失败率异常波动

## 7. 总结

此状态设计完整覆盖在线问诊业务全流程，具有以下特点：

### 7.1 设计优势
- ✅ **状态码分类清晰**：使用1xx/2xx/3xx/4xx/5xx/9xx前缀，易于理解和维护
- ✅ **流程完整严谨**：覆盖正常流程和所有异常分支
- ✅ **退款策略合理**：根据服务阶段差异化退款，平衡各方利益
- ✅ **异常处理完善**：针对各类异常场景提供明确处理策略
- ✅ **状态约束严格**：确保状态流转的正确性和一致性

### 7.2 实施建议
1. **数据库设计**：订单状态字段使用INT类型存储状态码
2. **状态机实现**：使用状态机模式，集中管理状态流转逻辑
3. **幂等性保证**：所有状态变更接口必须支持幂等
4. **分布式锁**：状态变更时使用分布式锁防止并发冲突
5. **异步处理**：超时检测、退款处理等使用异步任务
6. **监控告警**：建立完善的状态监控和异常告警机制

### 7.3 扩展性
- 支持新增问诊模式（如家庭医生、健康咨询等）
- 支持新增支付方式（如医保支付、积分支付等）
- 支持新增退款策略（如优惠券退款、分期退款等）
